<!DOCTYPE html><html lang="zh-CN" data-default-color-scheme="auto"><head><meta charset="UTF-8"><link rel="apple-touch-icon" sizes="76x76" href="https://static.muchen.fun/images/touch-icon.png"><link rel="icon" href="https://static.muchen.fun/images/favicon.ico"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=5,shrink-to-fit=no"><meta http-equiv="x-ua-compatible" content="ie=edge"><meta name="theme-color" content="#2f4154"><meta name="author" content="沐晨"><meta name="keywords" content="个人博客,个人见解,Java,Spring,IT,程序员,编程,技术,SpringBoot,JavaScript,分享,博客,Blog"><meta name="description" content="Optional类是Java8为了解决null值判断问题，借鉴google guava类库的Optional类而引入的一个同名Optional类，Optional 类主要解决的问题是臭名昭著的空指针异常（NullPointerException） —— 每个 Java 程序员都非常了解的异常。"><meta property="og:type" content="article"><meta property="og:title" content="Java Optional"><meta property="og:url" content="https://muchen.fun/passages/java-optional/index.html"><meta property="og:site_name" content="MuChen&#39;s Blog"><meta property="og:description" content="Optional类是Java8为了解决null值判断问题，借鉴google guava类库的Optional类而引入的一个同名Optional类，Optional 类主要解决的问题是臭名昭著的空指针异常（NullPointerException） —— 每个 Java 程序员都非常了解的异常。"><meta property="og:locale" content="zh_CN"><meta property="article:published_time" content="2019-10-21T08:20:39.000Z"><meta property="article:modified_time" content="2024-03-01T06:54:14.065Z"><meta property="article:author" content="沐晨"><meta property="article:tag" content="Java Optional"><meta name="twitter:card" content="summary_large_image"><title>Java Optional - MuChen&#39;s Blog</title><link rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css"><link rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css"><link rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css"><link rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css"><link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_hj8rtnfg7um.css"><link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css"><link rel="stylesheet" href="/css/main.css"><link id="highlight-css" rel="stylesheet" href="/css/highlight.css"><link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css"><script id="fluid-configs">var dntVal,Fluid=window.Fluid||{},CONFIG=(Fluid.ctx=Object.assign({},Fluid.ctx),{hostname:"muchen.fun",root:"/",version:"1.9.7",typing:{enable:!0,typeSpeed:70,cursorChar:"_",loop:!1,scope:[]},anchorjs:{enable:!0,element:"h1,h2,h3,h4,h5,h6",placement:"left",visible:"hover",icon:""},progressbar:{enable:!0,height_px:3,color:"#29d",options:{showSpinner:!1,trickleSpeed:100}},code_language:{enable:!0,default:"TEXT"},copy_btn:!0,image_caption:{enable:!0},image_zoom:{enable:!0,img_url_replace:["",""]},toc:{enable:!1,placement:"right",headingSelector:"h1,h2,h3,h4,h5,h6",collapseDepth:0},lazyload:{enable:!0,loading_img:"/img/loading.gif",onlypost:!1,offset_factor:2},web_analytics:{enable:!0,follow_dnt:!0,baidu:"b561ebd1192170893b7c07a8d4b71fc5",google:"UA-144841374-1",tencent:{sid:null,cid:null},woyaola:null,cnzz:null,leancloud:{app_id:"O8vCwRAgytvziX1uG5WgRn8R-MdYXbMMI",app_key:"5Rl3Rhl9zc8BJNvrPcncKWFy",server_url:"https://lean.muchen.fun",path:"window.location.pathname",ignore_local:!0},gtag:null},search_path:"/local-search.xml",include_content_in_search:!0});CONFIG.web_analytics.follow_dnt&&(dntVal=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,Fluid.ctx.dnt=dntVal&&(dntVal.startsWith("1")||dntVal.startsWith("yes")||dntVal.startsWith("on")))</script><script src="/js/utils.js"></script><script src="/js/color-schema.js"></script><script async>var _hmt;Fluid.ctx.dnt||(_hmt=_hmt||[],function(){var t=document.createElement("script"),e=(t.src="https://hm.baidu.com/hm.js?b561ebd1192170893b7c07a8d4b71fc5",document.getElementsByTagName("script")[0]);e.parentNode.insertBefore(t,e)}())</script><script async>Fluid.ctx.dnt||Fluid.utils.createScript("https://www.googletagmanager.com/gtag/js?id=",function(){function a(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],a("js",new Date),a("config","")})</script><meta name="generator" content="Hexo 7.1.1"></head><body><header><div class="header-inner" style="height:70vh"><nav id="navbar" class="navbar fixed-top navbar-expand-lg navbar-dark scrolling-navbar"><div class="container"><a class="navbar-brand" href="/"><strong>沐晨</strong> </a><button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation"><div class="animated-icon"><span></span><span></span><span></span></div></button><div class="collapse navbar-collapse" id="navbarSupportedContent"><ul class="navbar-nav ml-auto text-center"><li class="nav-item"><a class="nav-link" href="/" target="_self"><i class="iconfont icon-home-fill"></i> <span>首页</span></a></li><li class="nav-item"><a class="nav-link" href="/archives/" target="_self"><i class="iconfont icon-archive-fill"></i> <span>归档</span></a></li><li class="nav-item"><a class="nav-link" href="/categories/" target="_self"><i class="iconfont icon-category-fill"></i> <span>分类</span></a></li><li class="nav-item"><a class="nav-link" href="/tags/" target="_self"><i class="iconfont icon-tags-fill"></i> <span>标签</span></a></li><li class="nav-item"><a class="nav-link" href="/about/" target="_self"><i class="iconfont icon-user-fill"></i> <span>关于</span></a></li><li class="nav-item"><a class="nav-link" href="/links/" target="_self"><i class="iconfont icon-link-fill"></i> <span>友链</span></a></li><li class="nav-item" id="search-btn"><a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search"><i class="iconfont icon-search"></i></a></li><li class="nav-item" id="color-toggle-btn"><a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle"><i class="iconfont icon-dark" id="color-toggle-icon"></i></a></li></ul></div></div></nav><div id="banner" class="banner" parallax="true" style="background:url(https://static.muchen.fun/picture/15.jpg) no-repeat center center;background-size:cover"><div class="full-bg-img"><div class="mask flex-center" style="background-color:rgba(0,0,0,.3)"><div class="banner-text text-center fade-in-up"><div class="h2"><span id="subtitle" data-typed-text="Java Optional"></span></div><div class="mt-3"><span class="post-meta"><i class="iconfont icon-date-fill" aria-hidden="true"></i> <time datetime="2019-10-21 16:20" pubdate>2019年10月21日 下午</time></span></div><div class="mt-1"><span class="post-meta mr-2"><i class="iconfont icon-chart"></i> 2.9k 字 </span><span class="post-meta mr-2"><i class="iconfont icon-clock-fill"></i> 25 分钟 </span><span id="leancloud-page-views-container" class="post-meta" style="display:none"><i class="iconfont icon-eye" aria-hidden="true"></i> <span id="leancloud-page-views"></span> 次</span></div></div></div></div></div></div></header><main><div class="container-fluid nopadding-x"><div class="row nomargin-x"><div class="side-col d-none d-lg-block col-lg-2"></div><div class="col-lg-8 nopadding-x-md"><div class="container nopadding-x-md" id="board-ctn"><div id="board"><article class="post-content mx-auto"><h1 id="seo-header">Java Optional</h1><p id="updated-time" class="note note-info" style="display:none">本文最后更新于 2024-03-01T14:54:14+08:00</p><div class="markdown-body"><!-- more --><p><code>Java 8</code> 引入的一个很有趣的特性是 <code>Optional</code> 类。<code>Optional</code> 类主要解决的问题是臭名昭著的空指针异常（<code>NullPointerException</code>） —— 每个 <code>Java</code> 程序员都非常了解的异常。<br>本质上，这是一个包含有可选值的包装类，这意味着 <code>Optional</code> 类既可以含有对象也可以为空。</p><p><code>Optional</code> 是 <code>Java</code> 实现函数式编程的强劲一步，并且帮助在范式中实现。但是 <code>Optional</code> 的意义显然不止于此。</p><h2 id="背景介绍"><a href="#背景介绍" class="headerlink" title="背景介绍"></a>背景介绍</h2><p>从一个简单的用例开始。在 <code>Java 8</code> 之前，任何访问对象方法或属性的调用都可能导致<code>NullPointerException</code>：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">String</span> <span class="hljs-variable">isOcode</span> <span class="hljs-operator">=</span> user.getAddress().getCountry().getIsOcode().toUpperCase();<br></code></pre></td></tr></table></figure><p>在这个示例中，如果我们需要确保不触发异常，就得在访问每一个值之前对其进行明确地检查：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">if</span> (user != <span class="hljs-literal">null</span>) &#123;<br>    <span class="hljs-type">Address</span> <span class="hljs-variable">address</span> <span class="hljs-operator">=</span> user.getAddress();<br>    <span class="hljs-keyword">if</span> (address != <span class="hljs-literal">null</span>) &#123;<br>        <span class="hljs-type">Country</span> <span class="hljs-variable">country</span> <span class="hljs-operator">=</span> address.getCountry();<br>        <span class="hljs-keyword">if</span> (country != <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-type">String</span> <span class="hljs-variable">isOcode</span> <span class="hljs-operator">=</span> country.getIsOcode();<br>            <span class="hljs-keyword">if</span> (isOcode != <span class="hljs-literal">null</span>) &#123;<br>                isOcode = isOcode.toUpperCase();<br>            &#125;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>这很容易就导致代码变得冗长，难以维护。</p><p>为了简化这个过程，下面来看看用 <code>Optional</code> 类是怎么做的。从创建和验证实例，到使用其不同的方法，并与其它返回相同类型的方法相结合，下面是见证 <code>Optional</code> 奇迹的时刻。</p><h2 id="创建-Optional-实例"><a href="#创建-Optional-实例" class="headerlink" title="创建 Optional 实例"></a>创建 Optional 实例</h2><p>先看下 <code>Optional</code> 类的部分源码：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> Optional&lt;?&gt; EMPTY = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Optional</span>&lt;&gt;();<br><br><span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> T value;<br><br><span class="hljs-keyword">private</span> <span class="hljs-title function_">Optional</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-built_in">this</span>.value = <span class="hljs-literal">null</span>;<br>&#125;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span>&lt;T&gt; Optional&lt;T&gt; <span class="hljs-title function_">empty</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-meta">@SuppressWarnings(&quot;unchecked&quot;)</span><br>    Optional&lt;T&gt; t = (Optional&lt;T&gt;) EMPTY;<br>    <span class="hljs-keyword">return</span> t;<br>&#125;<br><br><span class="hljs-keyword">private</span> <span class="hljs-title function_">Optional</span><span class="hljs-params">(T value)</span> &#123;<br>    <span class="hljs-built_in">this</span>.value = Objects.requireNonNull(value);<br>&#125;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> &lt;T&gt; Optional&lt;T&gt; <span class="hljs-title function_">of</span><span class="hljs-params">(T value)</span> &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Optional</span>&lt;&gt;(value);<br>&#125;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> &lt;T&gt; Optional&lt;T&gt; <span class="hljs-title function_">ofNullable</span><span class="hljs-params">(T value)</span> &#123;<br>    <span class="hljs-keyword">return</span> value == <span class="hljs-literal">null</span> ? empty() : of(value);<br>&#125;<br></code></pre></td></tr></table></figure><p>可以看出，<code>Optional</code> 类的两个构造方法都是 <code>private</code> 型的，因此类外部不能显示的使用 <code>new Optional()</code> 的方式来创建 <code>Optional</code> 对象，但是 <code>Optional</code> 类提供了三个静态方法 <code>empty()</code>、<code>of(T value)</code>、<code>ofNullable(T value)</code>来创建 <code>Optinal</code> 对象。</p><p>使用同名方法创建一个空的 <code>Optional</code>：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Test(expected = NoSuchElementException.class)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">whenCreateEmptyOptional_thenNull</span><span class="hljs-params">()</span> &#123;<br>    Optional&lt;User&gt; emptyOpt = Optional.empty();<br>    emptyOpt.get();<br>&#125;<br></code></pre></td></tr></table></figure><p>毫无疑问，当调用 <code>get()</code> 方法获取 <code>emptyOpt</code> 的值时，会导致 <code>NoSuchElementException</code> 异常。</p><p>可以使用 <code>of()</code> 和 <code>ofNullable()</code> 方法创建包含值的 <code>Optional</code>。两个方法的不同之处在于如果你把 <code>null</code> 值作为参数传递进去，<code>of()</code> 方法会抛出 <code>NullPointerException</code>：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Test(expected = NullPointerException.class)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">whenCreateOfEmptyOptional_thenNullPointerException</span><span class="hljs-params">()</span> &#123;<br>    Optional&lt;User&gt; opt = Optional.of(user);<br>&#125;<br></code></pre></td></tr></table></figure><p>上面的代码并没有完全摆脱 <code>NullPointerException</code>。因此，你应该明确对象不为 <code>null</code> 的时候使用 <code>of()</code>。</p><p>如果对象即可能是 <code>null</code> 也可能是非 <code>null</code>，你就应该使用 <code>ofNullable()</code> 方法：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">Optional&lt;User&gt; opt = Optional.ofNullable(user);<br></code></pre></td></tr></table></figure><h2 id="访问-Optional-对象的值"><a href="#访问-Optional-对象的值" class="headerlink" title="访问 Optional 对象的值"></a>访问 Optional 对象的值</h2><p>从 <code>Optional</code> 实例中取回实际值对象的方法之一是使用 <code>get()</code> 方法：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//源码</span><br><span class="hljs-keyword">public</span> T <span class="hljs-title function_">get</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-keyword">if</span> (value == <span class="hljs-literal">null</span>) &#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">NoSuchElementException</span>(<span class="hljs-string">&quot;No value present&quot;</span>);<br>    &#125;<br>    <span class="hljs-keyword">return</span> value;<br>&#125;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">whenCreateOfNullableOptional_thenOk</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-type">String</span> <span class="hljs-variable">name</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;John&quot;</span>;<br>    Optional&lt;String&gt; opt = Optional.ofNullable(name);<br><br>    assertEquals(<span class="hljs-string">&quot;John&quot;</span>, opt.get());<br>&#125;<br></code></pre></td></tr></table></figure><p>不过，从源码可以知道，这个方法会在值为 <code>null</code> 的时候抛出异常。要避免异常，你可以选择首先验证是否有值：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//源码</span><br><span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isPresent</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-keyword">return</span> value != <span class="hljs-literal">null</span>;<br>&#125;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">whenCheckIfPresent_thenOk</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-type">User</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">User</span>(<span class="hljs-string">&quot;john@gmail.com&quot;</span>, <span class="hljs-string">&quot;1234&quot;</span>);<br>    Optional&lt;User&gt; opt = Optional.ofNullable(user);<br>    assertTrue(opt.isPresent());<br><br>    assertEquals(user.getEmail(), opt.get().getEmail());<br>&#125;<br></code></pre></td></tr></table></figure><p>检查是否有值的另一个选择是 <code>ifPresent()</code> 方法。该方法除了执行检查，还接受一个 <code>Consumer</code>(消费者) 参数，如果对象不是空的，就对执行传入的 <code>Lambda</code> 表达式：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//源码</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">ifPresent</span><span class="hljs-params">(Consumer&lt;? <span class="hljs-built_in">super</span> T&gt; consumer)</span> &#123;<br>    <span class="hljs-keyword">if</span> (value != <span class="hljs-literal">null</span>)<br>        consumer.accept(value);<br>&#125;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">whenCheckIfPresent</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-type">User</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">User</span>(<span class="hljs-string">&quot;john@gmail.com&quot;</span>, <span class="hljs-string">&quot;1234&quot;</span>);<br>    Optional&lt;User&gt; opt = Optional.ofNullable(user);<br>    opt.ifPresent( u -&gt; assertEquals(user.getEmail(), u.getEmail()));<br>&#125;<br></code></pre></td></tr></table></figure><p>这个例子中，只有 <code>user</code> 用户不为 <code>null</code> 的时候才会执行断言。</p><h2 id="返回默认值"><a href="#返回默认值" class="headerlink" title="返回默认值"></a>返回默认值</h2><p><code>Optional</code> 类提供了 <code>API</code> 用以返回对象值，或者在对象为空的时候返回默认值。</p><p>第一个方法是 <code>orElse()</code>，它的工作方式非常直接，如果有值则返回该值，否则返回传递给它的参数值：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//源码</span><br><span class="hljs-keyword">public</span> T <span class="hljs-title function_">orElse</span><span class="hljs-params">(T other)</span> &#123;<br>    <span class="hljs-keyword">return</span> value != <span class="hljs-literal">null</span> ? value : other;<br>&#125;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">whenEmptyValue_thenReturnDefault</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-type">User</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>    <span class="hljs-type">User</span> <span class="hljs-variable">user2</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">User</span>(<span class="hljs-string">&quot;anna@gmail.com&quot;</span>, <span class="hljs-string">&quot;1234&quot;</span>);<br>    <span class="hljs-type">User</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> Optional.ofNullable(user).orElse(user2);<br><br>    assertEquals(user2.getEmail(), result.getEmail());<br>&#125;<br></code></pre></td></tr></table></figure><p>这里 <code>user</code> 对象是空的，所以返回了作为默认值的 <code>user2</code>。</p><p>如果对象的初始值不是 <code>null</code>，那么默认值会被忽略：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">whenValueNotNull_thenIgnoreDefault</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-type">User</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">User</span>(<span class="hljs-string">&quot;john@gmail.com&quot;</span>,<span class="hljs-string">&quot;1234&quot;</span>);<br>    <span class="hljs-type">User</span> <span class="hljs-variable">user2</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">User</span>(<span class="hljs-string">&quot;anna@gmail.com&quot;</span>, <span class="hljs-string">&quot;1234&quot;</span>);<br>    <span class="hljs-type">User</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> Optional.ofNullable(user).orElse(user2);<br><br>    assertEquals(<span class="hljs-string">&quot;john@gmail.com&quot;</span>, result.getEmail());<br>&#125;<br></code></pre></td></tr></table></figure><p>第二个同类型的 <code>API</code> 是 <code>orElseGet()</code> —— 其行为略有不同。<br>这个方法会在有值的时候返回值，如果没有值，它会执行作为参数传入的 <code>Supplier</code>(供应者) 函数式接口，并将返回其执行结果：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//源码</span><br><span class="hljs-keyword">public</span> T <span class="hljs-title function_">orElseGet</span><span class="hljs-params">(Supplier&lt;? extends T&gt; other)</span> &#123;<br>    <span class="hljs-keyword">return</span> value != <span class="hljs-literal">null</span> ? value : other.get();<br>&#125;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">whenValueNotNull_thenIgnoreDefault</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-type">User</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">User</span>(<span class="hljs-string">&quot;john@gmail.com&quot;</span>,<span class="hljs-string">&quot;1234&quot;</span>);<br>    <span class="hljs-type">User</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> Optional.ofNullable(user).orElseGet( () -&gt; user2);<br>&#125;<br></code></pre></td></tr></table></figure><p><strong><code>orElse()</code> 和 <code>orElseGet()</code> 的不同之处</strong></p><p>乍一看，这两种方法似乎起着同样的作用。然而事实并非如此。下面创建一些示例来突出二者行为上的异同。</p><p>我们先来看看对象为空时它们的行为：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">givenEmptyValue_whenCompare_thenOk</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-type">User</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span><br>    logger.debug(<span class="hljs-string">&quot;Using orElse&quot;</span>);<br>    <span class="hljs-type">User</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> Optional.ofNullable(user).orElse(createNewUser());<br>    logger.debug(<span class="hljs-string">&quot;Using orElseGet&quot;</span>);<br>    <span class="hljs-type">User</span> <span class="hljs-variable">result2</span> <span class="hljs-operator">=</span> Optional.ofNullable(user).orElseGet(() -&gt; createNewUser());<br>&#125;<br><br><span class="hljs-keyword">private</span> User <span class="hljs-title function_">createNewUser</span><span class="hljs-params">()</span> &#123;<br>    logger.debug(<span class="hljs-string">&quot;Creating New User&quot;</span>);<br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">User</span>(<span class="hljs-string">&quot;extra@gmail.com&quot;</span>, <span class="hljs-string">&quot;1234&quot;</span>);<br>&#125;<br></code></pre></td></tr></table></figure><p>上面的代码中，两种方法都调用了 <code>createNewUser()</code> 方法，这个方法会记录一个消息并返回 <code>User</code> 对象。</p><p>代码输出如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java">Using orElse<br>Creating New User<br>Using orElseGet<br>Creating New User<br></code></pre></td></tr></table></figure><p>由此可见，当对象为空而返回默认对象时，行为并无差异。</p><p>接下来看一个类似的示例，但这里 <code>Optional</code> 不为空：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">givenPresentValue_whenCompare_thenOk</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-type">User</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">User</span>(<span class="hljs-string">&quot;john@gmail.com&quot;</span>, <span class="hljs-string">&quot;1234&quot;</span>);<br>    logger.info(<span class="hljs-string">&quot;Using orElse&quot;</span>);<br>    <span class="hljs-type">User</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> Optional.ofNullable(user).orElse(createNewUser());<br>    logger.info(<span class="hljs-string">&quot;Using orElseGet&quot;</span>);<br>    <span class="hljs-type">User</span> <span class="hljs-variable">result2</span> <span class="hljs-operator">=</span> Optional.ofNullable(user).orElseGet(() -&gt; createNewUser());<br>&#125;<br></code></pre></td></tr></table></figure><p>这次的输出就不同了：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java">Using orElse<br>Creating New User<br>Using orElseGet<br></code></pre></td></tr></table></figure><p>这个示例中，两个 <code>Optional</code> 对象都包含非空值，两个方法都会返回对应的非空值。不过，<code>orElse()</code> 方法仍然创建了 <code>User</code> 对象。与之相反，<code>orElseGet()</code> 方法不创建 <code>User</code> 对象。</p><p>在执行较密集的调用时，比如调用 <code>Web</code> 服务或数据查询，<strong>这个差异会对性能产生重大影响</strong>。</p><h2 id="返回异常"><a href="#返回异常" class="headerlink" title="返回异常"></a>返回异常</h2><p>除了 <code>orElse()</code> 和 <code>orElseGet()</code> 方法，<code>Optional</code> 还定义了 <code>orElseThrow() API</code> —— 它会在对象为空的时候抛出异常，而不是返回备选的值：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//源码</span><br><span class="hljs-keyword">public</span> &lt;X <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Throwable</span>&gt; T <span class="hljs-title function_">orElseThrow</span><span class="hljs-params">(Supplier&lt;? extends X&gt; exceptionSupplier)</span> <span class="hljs-keyword">throws</span> X &#123;<br>    <span class="hljs-keyword">if</span> (value != <span class="hljs-literal">null</span>) &#123;<br>        <span class="hljs-keyword">return</span> value;<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-keyword">throw</span> exceptionSupplier.get();<br>    &#125;<br>&#125;<br><br><span class="hljs-meta">@Test(expected = IllegalArgumentException.class)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">whenThrowException_thenOk</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-type">User</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> Optional.ofNullable(user)<br>      .orElseThrow( () -&gt; <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalArgumentException</span>());<br>&#125;<br></code></pre></td></tr></table></figure><p>这里，如果 <code>user</code> 值为 <code>null</code>，会抛出 <code>IllegalArgumentException</code>。</p><p>这个方法让我们有更丰富的语义，可以决定抛出什么样的异常，而不总是抛出 <code>NullPointerException</code>。</p><p>现在我们已经很好地理解了如何使用 <code>Optional</code>，下面来看看其它可以对 <code>Optional</code> 值进行转换和过滤的方法。</p><h2 id="转换值"><a href="#转换值" class="headerlink" title="转换值"></a>转换值</h2><p>有很多种方法可以转换 <code>Optional</code> 的值。先从 <code>map()</code> 和 <code>flatMap()</code> 方法开始。</p><p>先来看一个使用 <code>map() API</code> 的例子：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//源码</span><br><span class="hljs-keyword">public</span>&lt;U&gt; Optional&lt;U&gt; <span class="hljs-title function_">map</span><span class="hljs-params">(Function&lt;? <span class="hljs-built_in">super</span> T, ? extends U&gt; mapper)</span> &#123;<br>    Objects.requireNonNull(mapper);<br>    <span class="hljs-keyword">if</span> (!isPresent())<br>        <span class="hljs-keyword">return</span> empty();<br>    <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-keyword">return</span> Optional.ofNullable(mapper.apply(value));<br>    &#125;<br>&#125;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">whenMap_thenOk</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-type">User</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">User</span>(<span class="hljs-string">&quot;anna@gmail.com&quot;</span>, <span class="hljs-string">&quot;1234&quot;</span>);<br>    <span class="hljs-type">String</span> <span class="hljs-variable">email</span> <span class="hljs-operator">=</span> Optional.ofNullable(user)<br>      .map(u -&gt; u.getEmail()).orElse(<span class="hljs-string">&quot;default@gmail.com&quot;</span>);<br><br>    assertEquals(email, user.getEmail());<br>&#125;<br></code></pre></td></tr></table></figure><p><strong><code>map()</code> 对值应用(调用)作为参数的函数，然后将返回的值包装在 <code>Optional</code> 中</strong>。这就使对返回值进行链试调用的操作成为可能 —— 这里的下一环就是 <code>orElse()</code>。</p><p>相比这下，<code>flatMap()</code> 也需要函数作为参数，并对值调用这个函数，然后直接返回结果。</p><p>下面的操作中，我们给 <code>User</code> 类添加了一个方法，用来返回 <code>Optional</code>：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">User</span> &#123;    <br>    <span class="hljs-keyword">private</span> String position;<br><br>    <span class="hljs-keyword">public</span> Optional&lt;String&gt; <span class="hljs-title function_">getPosition</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> Optional.ofNullable(position);<br>    &#125;<br><br>    <span class="hljs-comment">//...</span><br>&#125;<br></code></pre></td></tr></table></figure><p>既然 <code>getter</code> 方法返回 <code>String</code> 值的 <code>Optional</code>，你可以在对 <code>User</code> 的 <code>Optional</code> 对象调用 <code>flatMap()</code> 时，用它作为参数。其返回的值是解除包装的 <code>String</code> 值：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//源码</span><br><span class="hljs-keyword">public</span>&lt;U&gt; Optional&lt;U&gt; <span class="hljs-title function_">flatMap</span><span class="hljs-params">(Function&lt;? <span class="hljs-built_in">super</span> T, Optional&lt;U&gt;&gt; mapper)</span> &#123;<br>    Objects.requireNonNull(mapper);<br>    <span class="hljs-keyword">if</span> (!isPresent())<br>        <span class="hljs-keyword">return</span> empty();<br>    <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-keyword">return</span> Objects.requireNonNull(mapper.apply(value));<br>    &#125;<br>&#125;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">whenFlatMap_thenOk</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-type">User</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">User</span>(<span class="hljs-string">&quot;anna@gmail.com&quot;</span>, <span class="hljs-string">&quot;1234&quot;</span>);<br>    user.setPosition(<span class="hljs-string">&quot;Developer&quot;</span>);<br>    <span class="hljs-type">String</span> <span class="hljs-variable">position</span> <span class="hljs-operator">=</span> Optional.ofNullable(user)<br>      .flatMap(u -&gt; u.getPosition()).orElse(<span class="hljs-string">&quot;default&quot;</span>);<br><br>    assertEquals(position, user.getPosition().get());<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="过滤值"><a href="#过滤值" class="headerlink" title="过滤值"></a>过滤值</h2><p>除了转换值之外，<code>Optional</code> 类也提供了按条件“过滤”值的方法。</p><p><strong><code>filter()</code> 接受一个 <code>Predicate</code> 参数，返回测试结果为 <code>true</code> 的值</strong>。如果测试结果为 <code>false</code>，会返回一个空的 <code>Optional</code>。</p><p>来看一个根据基本的电子邮箱验证来决定接受或拒绝 <code>User</code>(用户) 的示例：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//源码</span><br><span class="hljs-keyword">public</span> Optional&lt;T&gt; <span class="hljs-title function_">filter</span><span class="hljs-params">(Predicate&lt;? <span class="hljs-built_in">super</span> T&gt; predicate)</span> &#123;<br>    Objects.requireNonNull(predicate);<br>    <span class="hljs-keyword">if</span> (!isPresent())<br>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>;<br>    <span class="hljs-keyword">else</span><br>        <span class="hljs-keyword">return</span> predicate.test(value) ? <span class="hljs-built_in">this</span> : empty();<br>&#125;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">whenFilter_thenOk</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-type">User</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">User</span>(<span class="hljs-string">&quot;anna@gmail.com&quot;</span>, <span class="hljs-string">&quot;1234&quot;</span>);<br>    Optional&lt;User&gt; result = Optional.ofNullable(user)<br>      .filter(u -&gt; u.getEmail() != <span class="hljs-literal">null</span> &amp;&amp; u.getEmail().contains(<span class="hljs-string">&quot;@&quot;</span>));<br><br>    assertTrue(result.isPresent());<br>&#125;<br></code></pre></td></tr></table></figure><p>如果通过过滤器测试，<code>result</code> 对象会包含非空值。</p><h2 id="Optional-类的链式方法"><a href="#Optional-类的链式方法" class="headerlink" title="Optional 类的链式方法"></a>Optional 类的链式方法</h2><p>为了更充分的使用 <code>Optional</code>，你可以链接组合其大部分方法，因为它们都返回相同类似的对象。</p><p>我们使用 <code>Optional</code> 重写最早介绍的示例。</p><p>首先，重构类，使其 <code>getter</code> 方法返回 <code>Optional</code> 引用：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">User</span> &#123;<br>    <span class="hljs-keyword">private</span> Address address;<br><br>    <span class="hljs-keyword">public</span> Optional&lt;Address&gt; <span class="hljs-title function_">getAddress</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> Optional.ofNullable(address);<br>    &#125;<br><br>    <span class="hljs-comment">// ...</span><br>&#125;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Address</span> &#123;<br>    <span class="hljs-keyword">private</span> Country country;<br><br>    <span class="hljs-keyword">public</span> Optional&lt;Country&gt; <span class="hljs-title function_">getCountry</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> Optional.ofNullable(country);<br>    &#125;<br><br>    <span class="hljs-comment">// ...</span><br>&#125;<br></code></pre></td></tr></table></figure><p>现在可以删除 <code>null</code> 检查，替换为 <code>Optional</code> 的方法：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">whenChaining_thenOk</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-type">User</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">User</span>(<span class="hljs-string">&quot;anna@gmail.com&quot;</span>, <span class="hljs-string">&quot;1234&quot;</span>);<br><br>    <span class="hljs-type">String</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> Optional.ofNullable(user)<br>      .flatMap(u -&gt; u.getAddress())<br>      .flatMap(a -&gt; a.getCountry())<br>      .map(c -&gt; c.getIsocode())<br>      .orElse(<span class="hljs-string">&quot;default&quot;</span>);<br><br>    assertEquals(result, <span class="hljs-string">&quot;default&quot;</span>);<br>&#125;<br></code></pre></td></tr></table></figure><p>上面的代码还可以通过方法引用进一步缩减：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">String</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> Optional.ofNullable(user)<br>  .flatMap(User::getAddress)<br>  .flatMap(Address::getCountry)<br>  .map(Country::getIsocode)<br>  .orElse(<span class="hljs-string">&quot;default&quot;</span>);<br></code></pre></td></tr></table></figure><p>现在的代码看起来比之前采用条件分支的冗长代码就简洁多了。</p><h2 id="Optional-应该怎样用？"><a href="#Optional-应该怎样用？" class="headerlink" title="Optional 应该怎样用？"></a>Optional 应该怎样用？</h2><p>在使用 <code>Optional</code> 的时候需要考虑一些事情，以决定什么时候怎样使用它。</p><p>重要的一点是 <code>Optional</code> 不是 <code>Serializable</code>。因此，它不应该用作类的字段。</p><p>如果你需要序列化的对象包含 <code>Optional</code> 值，<code>Jackson</code> 库支持把 <code>Optional</code> 当作普通对象。也就是说，<code>Jackson</code> 会把空对象看作 <code>null</code>，而有值的对象则把其值看作对应域的值。这个功能在 <a target="_blank" rel="noopener" href="https://github.com/FasterXML/jackson-modules-java8">jackson-modules-java8</a> 项目中。</p><p>它在另一种情况下也并不怎么有用，就是在将其类型用作方法或构建方法的参数时。这样做会让代码变得复杂，完全没有必要：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">User</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">User</span>(<span class="hljs-string">&quot;john@gmail.com&quot;</span>, <span class="hljs-string">&quot;1234&quot;</span>, Optional.empty());<br></code></pre></td></tr></table></figure><p>使用重载方法来处理非要的参数要容易得多。</p><p><code>Optional</code> 主要用作返回类型。在获取到这个类型的实例后，如果它有值，你可以取得这个值，否则可以进行一些替代行为。</p><p><code>Optional</code> 类有一个非常有用的用例，就是将其与流或其它返回 <code>Optional</code> 的方法结合，以构建流畅的<code>API</code>。</p><p>下面来看一个示例，使用 <code>Stream</code> 返回 <code>Optional</code> 对象的 <code>findFirst()</code> 方法：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">whenEmptyStream_thenReturnDefaultOptional</span><span class="hljs-params">()</span> &#123;<br>    List&lt;User&gt; users = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br>    <span class="hljs-type">User</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> users.stream().findFirst().orElse(<span class="hljs-keyword">new</span> <span class="hljs-title class_">User</span>(<span class="hljs-string">&quot;default&quot;</span>, <span class="hljs-string">&quot;1234&quot;</span>));<br><br>    assertEquals(user.getEmail(), <span class="hljs-string">&quot;default&quot;</span>);<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="Java-9-增强"><a href="#Java-9-增强" class="headerlink" title="Java 9 增强"></a>Java 9 增强</h2><p><code>Java 9</code> 为 <code>Optional</code> 类添加了三个方法：<code>or()</code>、<code>ifPresentOrElse()</code> 和 <code>stream()</code>。</p><p><code>or()</code> 方法与 <code>orElse()</code> 和 <code>orElseGet()</code> 类似，它们都在对象为空的时候提供了替代情况。<code>or()</code> 的返回值是由 <code>Supplier</code> 参数产生的另一个 <code>Optional</code> 对象。</p><p>具体的这里不再介绍，读者可自行查找。</p><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p><code>Optional</code> 是 <code>Java</code> 语言的有益补充 —— 它旨在减少代码中的 <code>NullPointerExceptions</code>，虽然还不能完全消除这些异常。</p><p>它也是精心设计，自然融入 <code>Java 8</code> 函数式支持的功能。</p><p>总的来说，这个简单而强大的类有助于创建简单、可读性更强、比对应程序错误更少的程序。</p><p>参考：<br><a target="_blank" rel="noopener" href="https://www.oschina.net/translate/understanding-accepting-and-leveraging-optional-in?lang=chs&p=2">理解、学习与使用 Java 中的 Optional</a></p></div><hr><div><div class="post-metas my-3"><div class="post-meta mr-3 d-flex align-items-center"><i class="iconfont icon-category"></i> <span class="category-chains"><span class="category-chain"><a href="/categories/%E5%90%8E%E7%AB%AF/" class="category-chain-item">后端</a></span></span></div><div class="post-meta"><i class="iconfont icon-tags"></i> <a href="/tags/Java-Optional/" class="print-no-link">#Java Optional</a></div></div><div class="license-box my-3"><div class="license-title"><div>Java Optional</div><div>https://muchen.fun/passages/java-optional/</div></div><div class="license-meta"><div class="license-meta-item"><div>作者</div><div>沐晨</div></div><div class="license-meta-item license-meta-date"><div>发布于</div><div>2019年10月21日</div></div><div class="license-meta-item"><div>许可协议</div><div><a class="print-no-link" target="_blank" href="https://creativecommons.org/licenses/by/4.0/"><span class="hint--top hint--rounded" aria-label="BY - 署名"><i class="iconfont icon-by"></i></span></a></div></div></div><div class="license-icon iconfont"></div></div><div class="post-prevnext my-3"><article class="post-prev col-6"><a href="/passages/netty-understanding/" title="对Netty的一些理解"><i class="iconfont icon-arrowleft"></i> <span class="hidden-mobile">对Netty的一些理解</span> <span class="visible-mobile">上一篇</span></a></article><article class="post-next col-6"><a href="/passages/java-atomic-introduction/" title="Java Atomic简介"><span class="hidden-mobile">Java Atomic简介</span> <span class="visible-mobile">下一篇</span> <i class="iconfont icon-arrowright"></i></a></article></div></div><article id="comments" lazyload><div id="valine"></div><script>Fluid.utils.loadComments("#valine",function(){Fluid.utils.createScript("https://lib.baomitu.com/valine/1.4.16/Valine.min.js",function(){var i=Object.assign({appId:"O8vCwRAgytvziX1uG5WgRn8R-MdYXbMMI",appKey:"5Rl3Rhl9zc8BJNvrPcncKWFy",path:"window.location.pathname",placeholder:"说点什么吧~",avatar:"retro",meta:["nick","mail","link"],requiredFields:[],pageSize:10,lang:"zh-CN",highlight:!0,recordIP:!0,serverURLs:"https://lean.muchen.fun",emojiCDN:null,emojiMaps:null,enableQQ:!1},{el:"#valine",path:window.location.pathname});new Valine(i),Fluid.utils.waitElementVisible("#valine .vcontent",()=>{var i="#valine .vcontent img:not(.vemoji)";Fluid.plugins.imageCaption(i),Fluid.plugins.fancyBox(i)})})})</script><noscript>Please enable JavaScript to view the comments</noscript></article></article></div></div></div><div class="side-col d-none d-lg-block col-lg-2"></div></div></div><a id="scroll-top-button" aria-label="TOP" href="#" role="button"><i class="iconfont icon-arrowup" aria-hidden="true"></i></a><div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable modal-lg" role="document"><div class="modal-content"><div class="modal-header text-center"><h4 class="modal-title w-100 font-weight-bold">搜索</h4><button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button></div><div class="modal-body mx-3"><div class="md-form mb-5"><input type="text" id="local-search-input" class="form-control validate"> <label data-error="x" data-success="v" for="local-search-input">关键词</label></div><div class="list-group" id="local-search-result"></div></div></div></div></div></main><footer><div class="footer-inner"><div class="footer-content"><a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a></div><div class="statistics"><span id="leancloud-site-pv-container" style="display:none">总访问量 <span id="leancloud-site-pv"></span> 次 </span><span id="leancloud-site-uv-container" style="display:none">总访客数 <span id="leancloud-site-uv"></span> 人</span></div></div></footer><script src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js"></script><link rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css"><script>NProgress.configure({showSpinner:!1,trickleSpeed:100}),NProgress.start(),window.addEventListener("load",function(){NProgress.done()})</script><script src="https://lib.baomitu.com/jquery/3.6.0/jquery.min.js"></script><script src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js"></script><script src="/js/events.js"></script><script src="/js/plugins.js"></script><script src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js"></script><script>!function(t){var e=Fluid.plugins.typing,t=t.getElementById("subtitle");t&&e&&e(t.getAttribute("data-typed-text"))}((window,document))</script><script src="/js/img-lazyload.js"></script><script>var relativeDate=function(){var t,e,i,n=document.getElementById("updated-time");n&&((i=(t=n.textContent).match(e=/\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}(?:Z|[+-]\d{2}:\d{2})/))&&(i=moment(i[0]).fromNow(),n.textContent=t.replace(e,i)),n.style.display="")};Fluid.utils.createScript("https://lib.baomitu.com/moment.js/2.29.4/moment.min.js",function(){"zh-cn".startsWith("en")?relativeDate():Fluid.utils.createScript("https://lib.baomitu.com/moment.js/2.29.4/locale/zh-cn.min.js",function(){relativeDate()})})</script><script src="https://lib.baomitu.com/clipboard.js/2.0.10/clipboard.min.js"></script><script>Fluid.plugins.codeWidget()</script><script>Fluid.utils.createScript("https://lib.baomitu.com/anchor-js/4.3.1/anchor.min.js",function(){window.anchors.options={placement:CONFIG.anchorjs.placement,visible:CONFIG.anchorjs.visible},CONFIG.anchorjs.icon&&(window.anchors.options.icon=CONFIG.anchorjs.icon);var n,o=[];for(n of(CONFIG.anchorjs.element||"h1,h2,h3,h4,h5,h6").split(","))o.push(".markdown-body > "+n.trim());"left"===CONFIG.anchorjs.placement&&(window.anchors.options.class="anchorjs-link-left"),window.anchors.add(o.join(", ")),Fluid.events.registerRefreshCallback(function(){if("anchors"in window){anchors.removeAll();var n,o=[];for(n of(CONFIG.anchorjs.element||"h1,h2,h3,h4,h5,h6").split(","))o.push(".markdown-body > "+n.trim());"left"===CONFIG.anchorjs.placement&&(anchors.options.class="anchorjs-link-left"),anchors.add(o.join(", "))}})})</script><script>Fluid.utils.createScript("https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js",function(){Fluid.plugins.fancyBox()})</script><script>Fluid.plugins.imageCaption()</script><script defer src="/js/leancloud.js"></script><script src="/js/local-search.js"></script><script src="/js/boot.js"></script><noscript><div class="noscript-warning">博客在允许 JavaScript 运行的环境下浏览效果更佳</div></noscript></body></html>